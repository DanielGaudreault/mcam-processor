<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate CNC Viewer (Haas & Okuma Genos)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            color: #333;
            background-color: #f5f5f5;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #viewer-container {
            flex: 1;
            display: flex;
            width: 100%;
            height: calc(100% - 40px); /* Adjusted for ribbon height */
            position: relative;
            top: 40px; /* Offset for ribbon */
        }

        .ribbon {
            height: 40px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .toolset {
            display: flex;
            align-items: center;
        }

        .tb-group {
            display: flex;
            align-items: center;
        }

        .tool {
            padding: 6px 10px;
            cursor: pointer;
            color: #4a90e2;
            transition: color 0.2s, background 0.2s;
            display: flex;
            align-items: center;
        }

        .tool:hover {
            color: #357ab8;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .tool.disabled {
            color: #aaa;
            cursor: not-allowed;
        }

        .tool svg {
            width: 16px;
            height: 16px;
        }

        .divider {
            width: 1px;
            height: 24px;
            background: #ddd;
            margin: 0 5px;
        }

        .toolset.fill {
            flex-grow: 1;
        }

        .toolpath-logo {
            width: 16px;
            height: 16px;
            background: #4a90e2;
            border-radius: 50%;
        }

        .tool[data-tooltip]:hover:after {
            content: attr(data-tooltip);
            position: absolute;
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 1000;
            white-space: nowrap;
        }

        .pro-right:hover:after {
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            margin-left: 5px;
        }

        .pro-down:hover:after {
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 5px;
        }

        .pro-left:hover:after {
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            margin-right: 5px;
        }

        #file-input, #open-file {
            display: none;
        }

        /* Existing styles (abridged for brevity) */
        #sidebar {
            width: 320px;
            min-width: 200px;
            height: 100%;
            background: #fff;
            padding: 15px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            box-sizing: border-box;
            flex-shrink: 0;
            position: relative;
        }

        .dropdown-buttons {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
        }

        .nc-btn {
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        /* Rest of the existing CSS remains unchanged */
    </style>
</head>
<body>
    <div class="ribbon">
        <div class="toolset">
            <div class="tb-group">
                <div data-tooltip="Undo" class="tool protip pro-right disabled">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="reply" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-reply fa-w-16"><path fill="currentColor" d="M8.309 189.836L184.313 37.851C199.719 24.546 224 35.347 224 56.015v80.053c160.629 1.839 288 34.032 288 186.258 0 61.441-39.581 122.309-83.333 154.132-13.653 9.931-33.111-2.533-28.077-18.631 45.344-145.012-21.507-183.51-176.59-185.742V360c0 20.7-24.3 31.453-39.687 18.164l-176.004-152c-11.071-9.562-11.086-26.753 0-36.328z" class=""></path></svg>
                </div>
                <div data-tooltip="Redo" class="tool protip pro-right disabled">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="share" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-share fa-w-16"><path fill="currentColor" d="M503.691 189.836L327.687 37.851C312.281 24.546 288 35.347 288 56.015v80.053C127.371 137.907 0 170.1 0 322.326c0 61.441 39.581 122.309 83.333 154.132 13.653 9.931 33.111-2.533 28.077-18.631C66.066 312.814 132.917 274.316 288 272.085V360c0 20.7 24.3 31.453 39.687 18.164l176.004-152c11.071-9.562 11.086-26.753 0-36.328z" class=""></path></svg>
                </div>
            </div>
            <div class="divider"></div>
        </div>
        <div class="toolset">
            <div class="tb-group">
                <div data-tooltip="New File" class="tool protip pro-down" id="new-file-btn">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="file-plus" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="svg-inline--fa fa-file-plus fa-w-12"><path fill="currentColor" d="M377,105,279.1,7a24,24,0,0,0-17-7H256V128H384v-6.1A23.92,23.92,0,0,0,377,105ZM224,136V0H24A23.94,23.94,0,0,0,0,24V488a23.94,23.94,0,0,0,24,24H360a23.94,23.94,0,0,0,24-24V160H248A24.07,24.07,0,0,1,224,136Zm72,176v16a16,16,0,0,1-16,16H216v64a16,16,0,0,1-16,16H184a16,16,0,0,1-16-16V344H104a16,16,0,0,1-16-16V312a16,16,0,0,1,16-16h64V232a16,16,0,0,1,16-16h16a16,16,0,0,1,16,16v64h64A16,16,0,0,1,296,312Z" class=""></path></svg>
                </div>
                <form id="open-file-form" style="display: inline;">
                    <label id="open-file-btn-">
                        <span data-tooltip="Open File" class="tool protip pro-down">
                            <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="folder-open" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="svg-inline--fa fa-folder-open fa-w-18 fa-fw"><path fill="currentColor" d="M572.694 292.093L500.27 416.248A63.997 63.997 0 0 1 444.989 448H45.025c-18.523 0-30.064-20.093-20.731-36.093l72.424-124.155A64 64 0 0 1 152 256h399.964c18.523 0 30.064 20.093 20.73 36.093zM152 224h328v-48c0-26.51-21.49-48-48-48H272l-64-64H48C21.49 64 0 85.49 0 112v278.046l69.077-118.418C86.214 242.25 117.989 224 152 224z" class=""></path></svg>
                            <input type="file" id="open-file" accept=".gcode,.mcam,.nc,.tap">
                        </span>
                    </label>
                </form>
                <div data-tooltip="Save File" class="tool protip pro-down" id="save-file-btn">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="save" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="svg-inline--fa fa-save fa-w-14"><path fill="currentColor" d="M433.941 129.941l-83.882-83.882A48 48 0 0 0 316.118 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V163.882a48 48 0 0 0-14.059-33.941zM224 416c-35.346 0-64-28.654-64-64 0-35.346 28.654-64 64-64s64 28.654 64 64c0 35.346-28.654 64-64 64zm96-304.52V212c0 6.627-5.373 12-12 12H76c-6.627 0-12-5.373-12-12V108c0-6.627 5.373-12 12-12h228.52c3.183 0 6.235 1.264 8.485 3.515l3.48 3.48A11.996 11.996 0 0 1 320 111.48z" class=""></path></svg>
                </div>
            </div>
        </div>
        <div class="toolset">
            <div class="divider"></div>
            <div class="tb-group">
                <div data-tooltip="Load Example Program" class="tool protip pro-down" id="load-example-btn">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="download" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-download fa-w-16 fa-fw"><path fill="currentColor" d="M216 0h80c13.3 0 24 10.7 24 24v168h87.7c17.8 0 26.7 21.5 14.1 34.1L269.7 378.3c-7.5 7.5-19.8 7.5-27.3 0L90.1 226.1c-12.6-12.6-3.7-34.1 14.1-34.1H192V24c0-13.3 10.7-24 24-24zm296 376v112c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24V376c0-13.3 10.7-24 24-24h146.7l49 49c20.1 20.1 52.5 20.1 72.6 0l49-49H488c13.3 0 24 10.7 24 24zm-124 88c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20zm64 0c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20z" class=""></path></svg>
                    <span class="label">Sample</span>
                </div>
            </div>
            <div class="divider"></div>
        </div>
        <div class="toolset fill"></div>
        <div class="toolset">
            <div class="tb-group">
                <a href="https://toolpath.com/" class="tool" style="font-size: .75rem; display: flex; align-items: center; text-decoration: none;">
                    <div style="margin-right: 5px;">Toolpath Labs</div>
                    <div class="toolpath-logo"></div>
                </a>
                <div class="divider"></div>
                <div id="show-fps" data-tooltip="Performance Meter" class="tool protip pro-left">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tachometer-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="svg-inline--fa fa-tachometer-alt fa-w-18 fa-fw"><path fill="currentColor" d="M288 32C128.94 32 0 160.94 0 320c0 52.8 14.25 102.26 39.06 144.8 5.61 9.62 16.3 15.2 27.44 15.2h443c11.14 0 21.83-5.58 27.44-15.2C561.75 422.26 576 372.8 576 320c0-159.06-128.94-288-288-288zm0 64c14.71 0 26.58 10.13 30.32 23.65-1.11 2.26-2.64 4.23-3.45 6.67l-9.22 27.67c-5.13 3.49-10.97 6.01-17.64 6.01-17.67 0-32-14.33-32-32S270.33 96 288 96zM96 384c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32zm48-160c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32zm246.77-72.41l-61.33 184C343.13 347.33 352 364.54 352 384c0 11.72-3.38 22.55-8.88 32H232.88c-5.5-9.45-8.88-20.28-8.88-32 0-33.94 26.5-61.43 59.9-63.59l61.34-184.01c4.17-12.56 17.73-19.45 30.36-15.17 12.57 4.19 19.35 17.79 15.17 30.36zm14.66 57.2l15.52-46.55c3.47-1.29 7.13-2.23 11.05-2.23 17.67 0 32 14.33 32 32s-14.33 32-32 32c-11.38-.01-20.89-6.28-26.57-15.22zM480 384c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32z" class=""></path></svg>
                </div>
            </div>
        </div>
    </div>

    <div id="viewer-container">
        <input type="file" id="file-input" accept=".gcode,.mcam,.nc,.tap" />

        <div id="sidebar">
            <h3>G-Code Editor</h3>
            <textarea id="gcode-input" placeholder="Paste or edit G-code here (MCAM may show limited data)..."></textarea>
            <div id="info-panel">
                <h3>File Info</h3>
                <div class="info-item"><span class="info-label">File Name:</span><span id="file-name">None</span></div>
                <div class="info-item"><span class="info-label">File Size:</span><span id="file-size">0 KB</span></div>
                <div class="info-item"><span class="info-label">Toolpaths:</span><span id="toolpath-count">0</span></div>
                <div class="info-item"><span class="info-label">Bounds:</span><span id="bounds">N/A</span></div>
                <div class="info-item"><span class="info-label">Units:</span><span id="units">N/A</span></div>
                <div class="info-item"><span class="info-label">Current Tool:</span><span id="current-tool">N/A</span></div>
            </div>
            <div id="fixed-plot-btn" class="dropdown-buttons">
                <button id="plot-file-btn" class="nc-btn mx-1">Plot</button>
                <button id="clear-plot" class="nc-btn alt mx-1">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="ban" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-ban fa-w-16"><path fill="currentColor" d="M256 8C119.034 8 8 119.033 8 256s111.034 248 248 248 248-111.034 248-248S392.967 8 256 8zm130.108 117.892c65.448 65.448 70 165.481 20.677 235.637L150.47 105.216c70.204-49.356 170.226-44.735 235.638 20.676zM125.892 386.108c-65.448-65.448-70-165.481-20.677-235.637L361.53 406.784c-70.203 49.356-170.226 44.736-235.638-20.676z" class=""></path></svg>
                </button>
                <button id="settings-plot" aria-label="gcode editor options" class="nc-btn secondary mx-1">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="cog" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-cog fa-w-16"><path fill="currentColor" d="M487.4 315.7l-42.6-24.6c4.3-23.2 4.3-47 0-70.2l42.6-24.6c4.9-2.8 7.1-8.6 5.5-14-11.1-35.6-30-67.8-54.7-94.6-3.8-4.1-10-5.1-14.8-2.3L380.8 110c-17.9-15.4-38.5-27.3-60.8-35.1V25.8c0-5.6-3.9-10.5-9.4-11.7-36.7-8.2-74.3-7.8-109.2 0-5.5 1.2-9.4 6.1-9.4 11.7V75c-22.2 7.9-42.8 19.8-60.8 35.1L88.7 85.5c-4.9-2.8-11-1.9-14.8 2.3-24.7 26.7-43.6 58.9-54.7 94.6-1.7 5.4.6 11.2 5.5 14L67.3 221c-4.3 23.2-4.3 47 0 70.2l-42.6 24.6c-4.9 2.8-7.1 8.6-5.5 14 11.1 35.6 30 67.8 54.7 94.6 3.8 4.1 10 5.1 14.8 2.3l42.6-24.6c17.9 15.4 38.5 27.3 60.8 35.1v49.2c0 5.6 3.9 10.5 9.4 11.7 36.7 8.2 74.3 7.8 109.2 0 5.5-1.2 9.4-6.1 9.4-11.7v-49.2c22.2-7.9 42.8-19.8 60.8-35.1l42.6 24.6c4.9 2.8 11 1.9 14.8-2.3 24.7-26.7 43.6-58.9 54.7-94.6 1.5-5.5-.7-11.3-5.6-14.1zM256 336c-44.1 0-80-35.9-80-80s35.9-80 80-80 80 35.9 80 80-35.9 80-80 80z" class=""></path></svg>
                </button>
            </div>
        </div>

        <!-- Rest of the HTML (toolbar, canvas, etc.) remains unchanged -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/exporters/STLExporter.js"></script>

    <script>
        // Existing CNCViewer, McamParser, GcodeParser classes (unchanged)

        document.addEventListener('DOMContentLoaded', () => {
            const viewer = new CNCViewer();
            const gcodeInput = document.getElementById('gcode-input');
            const newFileBtn = document.getElementById('new-file-btn');
            const openFileInput = document.getElementById('open-file');
            const saveFileBtn = document.getElementById('save-file-btn');
            const loadExampleBtn = document.getElementById('load-example-btn');
            const showFpsBtn = document.getElementById('show-fps');
            const loadingOverlay = document.getElementById('loading-overlay');

            // Existing event listeners (abridged)

            newFileBtn.addEventListener('click', () => {
                gcodeInput.value = '';
                viewer.clearPlot();
            });

            openFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    loadingOverlay.style.display = 'flex';
                    const reader = new FileReader();
                    reader.onload = () => {
                        const buffer = reader.result;
                        const format = detectFileFormat(buffer, file.name);
                        if (format === 'MCAM') {
                            const parser = new McamParser(buffer);
                            const data = parser.parse();
                            if (data.success) {
                                viewer.loadToolpaths(data.toolpaths);
                                viewer.updateInfo(file, data);
                                gcodeInput.value = data.geometry ? 'Binary MCAM file - toolpaths only (not editable)' : gcodeInput.value;
                            } else {
                                alert(`MCAM parsing failed: ${data.error}`);
                            }
                        } else if (format === 'GCODE') {
                            const text = new TextDecoder().decode(buffer);
                            gcodeInput.value = text;
                            const parser = new GcodeParser(text);
                            const data = parser.parse();
                            if (data.success) {
                                viewer.loadToolpaths(data.toolpaths);
                                viewer.updateInfo(file, data);
                            } else {
                                alert('G-code parsing failed');
                            }
                        } else {
                            alert(`Unsupported file format: ${format}`);
                        }
                        loadingOverlay.style.display = 'none';
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            saveFileBtn.addEventListener('click', () => {
                const text = gcodeInput.value;
                if (!text.trim()) {
                    alert('No G-code to save.');
                    return;
                }
                const blob = new Blob([text], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'gcode.nc';
                link.click();
            });

            loadExampleBtn.addEventListener('click', () => {
                const exampleGcode = `G21\nG0 X0 Y0 Z5\nG1 X10 Y10 Z0 F500\nG1 X20 Y0\nG0 Z5`;
                gcodeInput.value = exampleGcode;
                viewer.plotGcode();
            });

            let fpsVisible = false;
            showFpsBtn.addEventListener('click', () => {
                fpsVisible = !fpsVisible;
                if (fpsVisible) {
                    let lastTime = performance.now();
                    let frameCount = 0;
                    const updateFps = () => {
                        const now = performance.now();
                        frameCount++;
                        if (now - lastTime >= 1000) {
                            const fps = frameCount;
                            showFpsBtn.setAttribute('data-tooltip', `Performance Meter: ${fps} FPS`);
                            frameCount = 0;
                            lastTime = now;
                        }
                        if (fpsVisible) requestAnimationFrame(updateFps);
                    };
                    updateFps();
                } else {
                    showFpsBtn.setAttribute('data-tooltip', 'Performance Meter');
                }
            });

            // Existing event listeners for plot buttons, etc. (unchanged)
        });
    </script>
</body>
</html>
